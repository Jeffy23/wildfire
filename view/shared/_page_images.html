<script>
  function toggle_browser() {
    if($('image_browser').style.width == '450px') {
      $('image_browser').style.width="0px";
      $('filter_block').style.display="none";
      $('image_list').style.display="none";
      $('drop_zones').style.display="none";
      toggle_selects("hidden");
    } else {
      $('image_browser').style.width="450px";
      $('filter_block').style.display="block";
      $('image_list').style.display="block";
      $('drop_zones').style.display="block";
      toggle_selects("visible");
    }
  }
  
  function toggle_selects(newState) {
    var elements = document.documentElement.getElementsByTagName('select');
    for (var i=0; i<elements.length; i++) {
      elements[i].style.visibility = newState;
    }

  }
</script>

<div id="image_browser_container">

  <div id="image_browser">
    <div id="filter_block">
      <form id="filter_form" action="">
        <strong>Filter images: </strong>(type some text from the filename)<br /> 
        <input type="text" id="image_filter" name="filter" size="20" />
      </form>
      <?=observe_field("image_filter", array(
        "url" => array("controller"=>"admin/files", "action"=>"image_filter"),
        "frequency" => "1",
        "update"=>"image_list",
        "with"=>"'filter='+value"
      ))?>
    </div>
    <div id="image_list">
      <?=javascript_tag("new Ajax.Updater('image_list', '/admin/files/browse_images', {evalScripts:true})")?>
    </div>
    
    
    <div id="drop_zones">
      <h4>Drop Images Here</h4>
      <div id="droppables">
        <?for($i=0; $i<$allowed_images; $i++):?>
          <?$displayed=false?>
          <div id="dropzone_<?=$i?>" class="attached_image">
            <?foreach($attached_images as $img):?>
              <?if($img->order==$i):?>
                <img src="/admin/files/show_image/<?=$img->id?>">
                <?=link_to_remote(image_tag("/images/cms/trash.gif"), array(
                  "update"=> "dropzone_".$i,
                  "url"   => array("action"=>"remove_image", "id"=>$page->id, "image"=>$img->id)
                ))?>
                <?$displayed=true;?>
              <?endif?>
            <?endforeach?>
            <?if(!$displayed):?>
              <img src="/images/cms/image-drop-zone.gif" />
            <?endif?>
          </div>
          <?=drop_receiving_element("dropzone_".$i, array(
            "update" => "dropzone_".$i,
            "url" => array("action" => "add_image", "id"=>$page->id, "order"=>$i),
            "hoverclass" => "dropzone_active"
          ))?>
        <?endfor?>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
  <div id="image_browse_tab" class="clearfix">
    <img src="/images/cms/image-browse-tab.gif" onclick="toggle_browser();" />
  </div>
  
</div>